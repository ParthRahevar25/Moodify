<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodMate - Your Personal Emotion Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --accent-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.37);
            --shadow-medium: 0 15px 35px rgba(31, 38, 135, 0.2);
            --shadow-strong: 0 20px 40px rgba(31, 38, 135, 0.3);
            
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            
            --border-radius: 16px;
            --border-radius-lg: 24px;
            --border-radius-xl: 32px;
            
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Dynamic background based on persona */
        body.joy { background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 50%, #fd79a8 100%); }
        body.sadness { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #6c5ce7 100%); }
        body.anger { background: linear-gradient(135deg, #fd79a8 0%, #e84393 50%, #a29bfe 100%); }
        body.fear { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 50%, #74b9ff 100%); }
        body.love { background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 50%, #e17055 100%); }
        body.surprise { background: linear-gradient(135deg, #fdcb6e 0%, #ffeaa7 50%, #fab1a0 100%); }
        body.neutral { background: linear-gradient(135deg, #81ecec 0%, #74b9ff 50%, #a29bfe 100%); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
            position: relative;
        }

        /* Floating particles background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        /* Header Section */
        .header {
            text-align: center;
            color: white;
            margin-bottom: var(--spacing-2xl);
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.9;
            margin-bottom: var(--spacing-lg);
            letter-spacing: 0.5px;
        }

        .system-status {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 50px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

        .system-status:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .system-status.fallback {
            background: rgba(255,165,0,0.25);
        }

        /* Glass morphism containers */
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .glass-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        }

        /* Input Section */
        .input-section {
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            position: relative;
            z-index: 10;
        }

        .input-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .input-form label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: var(--spacing-sm);
        }

        .input-form textarea {
            padding: var(--spacing-lg);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: var(--border-radius);
            font-size: 16px;
            resize: vertical;
            min-height: 140px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .input-form textarea:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.1), inset 0 2px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .submit-btn {
            padding: var(--spacing-lg) var(--spacing-2xl);
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .submit-btn:hover::before {
            left: 100%;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-strong);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* Persona Section */
        .persona-section {
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            transform: scale(0);
            animation: scaleIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            position: relative;
            z-index: 10;
        }

        @keyframes scaleIn {
            to { transform: scale(1); }
        }

        .persona-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .persona-avatar {
            font-size: 5rem;
            animation: bounce 2s infinite ease-in-out;
            cursor: pointer;
            transition: transform 0.3s ease;
            background: var(--accent-gradient);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
        }

        .persona-avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-15px); }
            60% { transform: translateY(-8px); }
        }

        .persona-info h2 {
            font-family: 'Playfair Display', serif;
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .persona-traits {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: var(--spacing-md);
            font-size: 1.1rem;
        }

        .intensity-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--success-gradient);
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-soft);
        }

        .emotion-confidence {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(255,255,255,0.5);
            border-radius: var(--border-radius);
            backdrop-filter: blur(8px);
        }

        .confidence-bar {
            flex-grow: 1;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .confidence-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 4px;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .confidence-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Enhanced Greeting */
        .persona-greeting {
            background: var(--secondary-gradient);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            margin: var(--spacing-xl) 0;
            text-align: center;
            font-size: 1.3rem;
            line-height: 1.6;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .persona-greeting::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Quote Section */
        .quote-section {
            background: rgba(255, 255, 255, 0.9);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            margin: var(--spacing-xl) 0;
            border-left: 6px solid transparent;
            border-image: var(--primary-gradient) 1;
            font-size: 1.3rem;
            font-style: italic;
            text-align: center;
            position: relative;
            backdrop-filter: blur(8px);
            box-shadow: var(--shadow-soft);
        }

        .quote-section::before {
            content: '"';
            font-size: 6rem;
            color: rgba(102, 126, 234, 0.1);
            position: absolute;
            top: -20px;
            left: var(--spacing-lg);
            font-family: 'Playfair Display', serif;
        }

        /* Chat Section */
        .chat-section {
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            position: relative;
            z-index: 10;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(8px);
        }

        .chat-input-section {
            display: flex;
            gap: var(--spacing-md);
            align-items: flex-end;
        }

        .chat-input {
            flex-grow: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.1);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--spacing-xl);
            margin-top: var(--spacing-2xl);
        }

        .content-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
        }

        .content-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-strong);
            border-color: rgba(255,255,255,0.3);
        }

        .content-card h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 1.4rem;
            font-weight: 600;
        }

        /* Activities */
        .activities-list {
            list-style: none;
        }

        .activities-list li {
            padding: var(--spacing-md) var(--spacing-lg);
            margin: var(--spacing-md) 0;
            background: rgba(255,255,255,0.7);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
            backdrop-filter: blur(8px);
        }

        .activities-list li:hover {
            transform: translateX(8px);
            background: rgba(255,255,255,0.9);
            border-left-color: #667eea;
            box-shadow: var(--shadow-soft);
        }

        .activity-btn {
            width: 100%;
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

        .activity-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Emotion Spectrum */
        .emotion-spectrum {
            margin: var(--spacing-lg) 0;
        }

        .spectrum-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(8px);
        }

        .spectrum-item:hover {
            background: rgba(255,255,255,0.5);
            transform: translateX(4px);
        }

        .spectrum-label {
            min-width: 90px;
            font-weight: 600;
            text-transform: capitalize;
            font-size: 0.95rem;
        }

        .spectrum-bar {
            flex-grow: 1;
            height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .spectrum-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 6px;
            transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .spectrum-percentage {
            min-width: 55px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Floating Action Buttons */
        .floating-buttons {
            position: fixed;
            bottom: var(--spacing-2xl);
            right: var(--spacing-2xl);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            z-index: 100;
        }

        .floating-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(16px);
            position: relative;
            overflow: hidden;
        }

        .floating-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .floating-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .floating-btn:hover {
            transform: scale(1.1) translateY(-4px);
            box-shadow: var(--shadow-strong);
        }

        .history-btn { background: var(--primary-gradient); }
        .analytics-btn { background: var(--warning-gradient); }
        .compare-btn { background: var(--success-gradient); }

        /* Modal Enhancements */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            margin: 5% auto;
            padding: var(--spacing-2xl);
            border-radius: var(--border-radius-xl);
            border: 1px solid var(--glass-border);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Loading animations */
        .loading {
            display: none;
            text-align: center;
            padding: var(--spacing-xl);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-lg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }
            
            .persona-header {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-md);
            }

            .persona-avatar {
                font-size: 3.5rem;
                width: 100px;
                height: 100px;
            }

            .floating-buttons {
                bottom: var(--spacing-lg);
                right: var(--spacing-lg);
                gap: var(--spacing-sm);
            }

            .floating-btn {
                width: 56px;
                height: 56px;
                font-size: 1.3rem;
            }

            .system-status {
                position: relative;
                display: inline-block;
                margin-top: var(--spacing-md);
            }

            .input-section, .persona-section, .content-card {
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 480px) {
            .persona-info h2 {
                font-size: 2rem;
            }

            .quote-section {
                font-size: 1.1rem;
                padding: var(--spacing-lg);
            }

            .modal-content {
                margin: 10% auto;
                padding: var(--spacing-lg);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-gradient);
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Focus states */
        button:focus, input:focus, textarea:focus {
            outline: 2px solid rgba(255,255,255,0.6);
            outline-offset: 2px;
        }

        /* Enhanced animations */
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.6s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .slide-up {
            transform: translateY(30px);
            opacity: 0;
            animation: slideUp 0.6s ease forwards;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Error states */
        .error-message {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
            text-align: center;
            box-shadow: var(--shadow-soft);
            border-left: 4px solid #ff5252;
        }

        /* Success states */
        .success-message {
            background: var(--success-gradient);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
            text-align: center;
            box-shadow: var(--shadow-soft);
        }
    </style>
</head>
<body class="theme-transition">
    <!-- Floating particles background -->
    <div class="particles" id="particles"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🌟 MoodMate</h1>
            <p class="subtitle">Your Personal AI Emotion Companion</p>
            <div class="system-status {% if fallback_mode %}fallback{% endif %}" 
                 onclick="showSystemStatus()" 
                 title="Click to view system status">
                {% if fallback_mode %}⚠️ Fallback Mode{% else %}✅ AI Active{% endif %}
            </div>
        </header>

        <!-- Demo Controls -->
        <div class="demo-controls" style="display: {% if demo_mode %}flex{% else %}none{% endif %}; gap: var(--spacing-md); justify-content: center; margin-bottom: var(--spacing-xl);">
            <button class="demo-btn" onclick="resetDemo()">🔄 Reset Demo</button>
            <button class="demo-btn" onclick="generateSampleData()">📊 Generate Sample Data</button>
            <button class="demo-btn" onclick="showComparison()">⚖️ Compare Emotions</button>
            <button class="demo-btn" onclick="toggleRealtimePreview()">👁️ Real-time Preview</button>
        </div>

        <style>
            .demo-btn {
                padding: var(--spacing-sm) var(--spacing-lg);
                background: var(--glass-bg);
                backdrop-filter: blur(16px);
                color: white;
                border: 1px solid var(--glass-border);
                border-radius: 25px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
                transition: all 0.3s ease;
                box-shadow: var(--shadow-soft);
            }

            .demo-btn:hover {
                background: rgba(255,255,255,0.3);
                transform: translateY(-2px);
                box-shadow: var(--shadow-medium);
            }
        </style>

        <!-- Error Message -->
        {% if error_message %}
        <div class="error-message">
            {{ error_message }}
        </div>
        {% endif %}

        <!-- Input Section -->
        <div class="input-section glass-container">
            <form class="input-form" method="POST" onsubmit="handleSubmit(event)">
                <label for="user_input">
                    How are you feeling right now? Share what's on your mind...
                </label>
                <textarea name="user_input" 
                         id="user_input" 
                         placeholder="I'm feeling... because..."
                         oninput="handleTextInput(this)"
                         required></textarea>
                
                <!-- Real-time Emotion Preview -->
                <div class="emotion-preview" id="emotion-preview" style="display: none; background: rgba(255,255,255,0.2); padding: var(--spacing-md); border-radius: var(--border-radius); margin-top: var(--spacing-md); font-size: 0.9rem; color: var(--text-primary); backdrop-filter: blur(8px);">
                    <span id="preview-text"></span>
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">
                    ✨ Analyze My Mood
                </button>
            </form>
            
            <!-- Loading Animation -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="color: white; font-weight: 500;">Analyzing your emotions with AI...</p>
            </div>
        </div>

        <!-- Persona Results Section -->
        {% if persona %}
        <div class="persona-section glass-container">
            <!-- Persona Header -->
            <div class="persona-header">
                <div class="persona-avatar" onclick="showPersonaDetails('{{ emotion_data.emotion }}')">
                    {{ persona.avatar }}
                </div>
                <div class="persona-info">
                    <h2>Meet {{ persona.name }}</h2>
                    <p class="persona-traits">{{ persona.personality }}</p>
                    {% if emotion_data %}
                    <div class="emotion-confidence">
                        <span style="font-weight: 600;">Detected: <strong>{{ emotion_data.emotion.title() }}</strong></span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" 
                                 style="width: {{ (emotion_data.confidence * 100)|round }}%"></div>
                        </div>
                        <span style="font-weight: 600;">{{ "%.0f"|format(emotion_data.confidence * 100) }}%</span>
                    </div>
                    {% if emotion_data.intensity %}
                    <div class="intensity-badge">
                        {{ emotion_data.intensity }} intensity
                    </div>
                    {% endif %}
                    {% if emotion_data.fallback_used %}
                    <div style="font-size: 0.8rem; color: #ff6b6b; margin-top: var(--spacing-sm); padding: var(--spacing-xs) var(--spacing-sm); background: rgba(255,107,107,0.1); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                        ⚠️ Using keyword-based analysis
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Chat Interface Section -->
            <div class="chat-section glass-container" style="margin-top: var(--spacing-xl);">
                <div class="chat-header">
                    <div style="font-size: 2rem;">{{ persona.avatar }}</div>
                    <div>
                        <h3 style="margin: 0; color: var(--text-primary); font-weight: 600;">Chat with {{ persona.name }}</h3>
                        <p style="margin: 5px 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">Your personal AI therapist</p>
                        <div id="llama-status" style="font-size: 0.8rem; margin-top: 5px;">
                            {% if LLAMA_AVAILABLE %}
                            <span style="color: #4caf50; font-weight: 500;">🦙 Llama 3.2 Active</span>
                            {% else %}
                            <span style="color: #ff9800; font-weight: 500;">⚠️ Using Fallback Mode</span>
                            {% endif %}
                        </div>
                    </div>
                    <div style="margin-left: auto;">
                        <button onclick="clearChatHistory()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.3s ease; box-shadow: var(--shadow-soft);">
                            🗑️ Clear Chat
                        </button>
                    </div>
                </div>
                
                <div id="chat-messages" class="chat-messages">
                    <div class="welcome-message" style="text-align: center; color: var(--text-muted); font-style: italic; padding: var(--spacing-xl); background: rgba(255,255,255,0.1); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                        Hi! I'm {{ persona.name }}. How can I support you today? Feel free to share what's on your mind.
                    </div>
                </div>
                
                <div class="chat-input-section">
                    <input type="text" 
                           id="chat-input" 
                           class="chat-input"
                           placeholder="Type your message here..." 
                           onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendChatMessage()" 
                            id="send-button"
                            style="padding: var(--spacing-md) var(--spacing-xl); background: var(--primary-gradient); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: var(--shadow-soft);">
                        Send
                    </button>
                </div>
                
                <div style="margin-top: var(--spacing-md); font-size: 0.8rem; color: var(--text-muted); text-align: center;">
                    Press Enter to send • Responses powered by AI
                </div>
            </div>

            <!-- Persona Greeting -->
            {% if greeting %}
            <div class="persona-greeting fade-in">
                {{ greeting }}
            </div>
            {% endif %}

            <!-- Quote Section -->
            {% if quote %}
            <div class="quote-section slide-up">
                {{ quote }}
                <br><small style="font-weight: 600; color: var(--text-secondary);">- {{ persona.name }}</small>
            </div>
            {% endif %}

            <!-- Conversation Starter -->
            {% if conversation_starter %}
            <div class="conversation-starter" onclick="startConversation()" style="background: var(--success-gradient); color: white; padding: var(--spacing-xl); border-radius: var(--border-radius-lg); text-align: center; margin: var(--spacing-xl) 0; font-size: 1.2rem; position: relative; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--shadow-medium);">
                <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">💭</div>
                {{ conversation_starter }}
            </div>
            {% endif %}
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Enhanced Activities -->
            {% if activities %}
            <div class="content-card">
                <h3>🎯 Personalized Activities</h3>
                <ul class="activities-list">
                    {% for activity in activities %}
                    <li onclick="selectActivity(this)">{{ activity }}</li>
                    {% endfor %}
                </ul>
                <button class="activity-btn" 
                        onclick="getMoreActivities('{{ emotion_data.emotion if emotion_data else 'neutral' }}')">
                    🎲 Get More Ideas
                </button>
            </div>
            {% endif %}

            <!-- Enhanced Emotion Spectrum -->
            {% if emotion_data and emotion_data.all_emotions %}
            <div class="content-card">
                <h3>🎨 Your Emotional Spectrum</h3>
                <p style="margin-bottom: var(--spacing-lg); color: var(--text-secondary); line-height: 1.6;">
                    Understanding the full range of your emotions:
                </p>
                <div class="emotion-spectrum">
                    {% for emotion in emotion_data.all_emotions[:5] %}
                    <div class="spectrum-item">
                        <div class="spectrum-label">{{ emotion.label.title() }}</div>
                        <div class="spectrum-bar">
                            <div class="spectrum-fill" 
                                 style="width: {{ (emotion.score * 100)|round }}%"></div>
                        </div>
                        <div class="spectrum-percentage">{{ "%.0f"|format(emotion.score * 100) }}%</div>
                    </div>
                    {% endfor %}
                </div>
                <button class="activity-btn" onclick="showDetailedAnalysis()">
                    🔍 Detailed Analysis
                </button>
            </div>
            {% endif %}

            <!-- Enhanced Music Section -->
            {% if spotify_tracks %}
            <div class="content-card">
                <h3>🎵 Music for Your Mood</h3>
                <p style="margin-bottom: var(--spacing-lg); color: var(--text-secondary); line-height: 1.6;">
                    Curated tracks that match your {{ emotion_data.emotion if emotion_data else 'current' }} mood:
                </p>
                {% for track_id in spotify_tracks[:3] %}
                <iframe src="https://open.spotify.com/embed/track/{{ track_id }}?utm_source=generator&theme=0" 
                        style="width: 100%; height: 90px; border: none; border-radius: var(--border-radius); margin: var(--spacing-md) 0; box-shadow: var(--shadow-soft);" 
                        frameborder="0" 
                        allowfullscreen=""
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                        loading="lazy">
                </iframe>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Enhanced Game Section -->
            {% if game_url %}
            <div class="content-card">
                <h3>🎮 Interactive Therapy Game</h3>
                <div style="text-align: center; padding: var(--spacing-lg) 0;">
                    <p style="margin-bottom: var(--spacing-lg); line-height: 1.6;">
                        A therapeutic game designed specifically for your <strong>{{ emotion_data.emotion if emotion_data else 'current' }}</strong> state:
                    </p>
                    <a href="{{ game_url }}" style="display: inline-block; padding: var(--spacing-lg) var(--spacing-2xl); background: linear-gradient(45deg, #ff6b6b, #feca57); color: white; text-decoration: none; border-radius: 30px; font-weight: 600; font-size: 1.1rem; transition: all 0.3s ease; box-shadow: var(--shadow-medium);" target="_blank">
                        🎯 Start Playing
                    </a>
                    <p style="margin-top: var(--spacing-md); font-size: 0.9rem; color: var(--text-muted); line-height: 1.5;">
                        Games can help process emotions in a healthy, engaging way.
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- AI Insights Card -->
            <div class="content-card">
                <h3>🤖 AI Insights</h3>
                {% if emotion_data %}
                <div style="space-y: var(--spacing-md);">
                    <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: rgba(255,255,255,0.3); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                        <strong>Analysis Method:</strong> 
                        {% if emotion_data.fallback_used %}
                        <span style="color: #ff9800;">Keyword-based detection</span>
                        {% else %}
                        <span style="color: #4caf50;">Advanced AI emotion recognition</span>
                        {% endif %}
                    </div>
                    <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: rgba(255,255,255,0.3); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                        <strong>Confidence Level:</strong> 
                        <span style="color: {% if emotion_data.confidence > 0.7 %}#4caf50{% elif emotion_data.confidence > 0.4 %}#ff9800{% else %}#f44336{% endif %}; font-weight: 600;">
                            {{ "%.0f"|format(emotion_data.confidence * 100) }}%
                        </span>
                    </div>
                    <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: rgba(255,255,255,0.3); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                        <strong>Persona Match:</strong> {{ persona.name }} 
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">
                            ({{ persona.personality }})
                        </span>
                    </div>
                </div>
                {% else %}
                <p style="color: var(--text-secondary); line-height: 1.6; text-align: center; padding: var(--spacing-lg);">
                    Share your feelings to see detailed AI insights about your emotional state!
                </p>
                {% endif %}
                <button class="activity-btn" onclick="explainAnalysis()" style="margin-top: var(--spacing-lg);">
                    📖 How This Works
                </button>
            </div>
        </div>

        <!-- Follow-up Suggestions Section -->
        <div class="followup-suggestions glass-container" id="followup-suggestions" style="display: none; margin-top: var(--spacing-2xl); padding: var(--spacing-xl);">
            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">💡 What's Next?</h3>
            <div id="followup-content"></div>
        </div>
        {% endif %}
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-buttons">
        <button class="floating-btn history-btn" onclick="showHistory()" title="View Mood History">
            📊
        </button>
        <button class="floating-btn analytics-btn" onclick="showAnalytics()" title="Analytics Dashboard">
            📈
        </button>
        <button class="floating-btn compare-btn" onclick="showComparison()" title="Compare Emotions">
            ⚖️
        </button>
    </div>

    <!-- All Modal HTML and JavaScript remains the same as the original, just with enhanced styling -->
    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('historyModal')" style="color: var(--text-muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;">&times;</span>
            <h2 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">📊 Your Mood Journey</h2>
            <div id="history-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Loading your mood history...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('analyticsModal')" style="color: var(--text-muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;">&times;</span>
            <h2 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">📈 Analytics Dashboard</h2>
            <div id="analytics-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Generating analytics...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('comparisonModal')" style="color: var(--text-muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;">&times;</span>
            <h2 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">⚖️ Emotion Comparison Tool</h2>
            <div id="comparison-content">
                <p style="margin-bottom: var(--spacing-lg); color: var(--text-secondary); line-height: 1.6;">Compare how different text inputs are analyzed for emotions:</p>
                <div id="comparison-inputs">
                    <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                        <input type="text" style="flex-grow: 1; padding: var(--spacing-md); border: 2px solid rgba(255,255,255,0.2); border-radius: var(--border-radius); background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);" placeholder="Enter first text sample..." />
                        <button onclick="addComparisonInput()" style="padding: var(--spacing-md) var(--spacing-lg); background: var(--primary-gradient); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 500;">+ Add</button>
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                        <input type="text" style="flex-grow: 1; padding: var(--spacing-md); border: 2px solid rgba(255,255,255,0.2); border-radius: var(--border-radius); background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);" placeholder="Enter second text sample..." />
                    </div>
                </div>
                <button class="activity-btn" onclick="runComparison()" style="margin: var(--spacing-lg) 0;">
                    🔍 Compare Emotions
                </button>
                <div id="comparison-results"></div>
            </div>
        </div>
    </div>

    <!-- Persona Details Modal -->
    <div id="personaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('personaModal')" style="color: var(--text-muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;">&times;</span>
            <h2 id="persona-modal-title" style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">Persona Details</h2>
            <div id="persona-modal-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Loading persona details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Modal -->
    <div id="systemStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('systemStatusModal')" style="color: var(--text-muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;">&times;</span>
            <h2 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">🛠️ System Status</h2>
            <div id="system-status-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Checking system status...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Create floating particles
        function createParticles() {
            const particles = document.getElementById('particles');
            const particleCount = 15;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.width = particle.style.height = Math.random() * 10 + 5 + 'px';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                particles.appendChild(particle);
            }
        }

        // Initialize particles and other effects
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            setupEventListeners();
            setupAnimations();
            
            // Add staggered animations to content cards
            const cards = document.querySelectorAll('.content-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = (index * 0.1) + 's';
                card.classList.add('fade-in');
            });
            
            {% if persona %}
            // Update body class for persona-specific background
            document.body.className = 'theme-transition {{ emotion_data.emotion if emotion_data else "neutral" }}';
            
            setTimeout(() => {
                typeWriterEffect('.persona-greeting', 50);
            }, 500);
            {% endif %}
        });

        // All JavaScript functions remain the same as the original
        // Global variables
        let realtimePreview = false;
        let typingTimer;
        const typingInterval = 1000;
        let currentEmotion = '{{ emotion_data.emotion if emotion_data else "neutral" }}';
        let chatHistory = [];

        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                padding: var(--spacing-lg) var(--spacing-xl);
                border-radius: var(--border-radius-lg);
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                box-shadow: var(--shadow-strong);
                backdrop-filter: blur(16px);
                border: 1px solid rgba(255,255,255,0.2);
            `;
            
            const gradients = {
                'success': 'var(--success-gradient)',
                'error': 'linear-gradient(135deg, #ff6b6b, #ee5a52)',
                'warning': 'var(--warning-gradient)',
                'info': 'var(--primary-gradient)'
            };
            
            notification.style.background = gradients[type] || gradients.info;
            notification.innerHTML = message.replace(/\n/g, '<br>');
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            }, duration);
        }

        // Rest of the JavaScript functions remain exactly the same as the original
        // Including all chat functions, modal functions, etc.
        
        function setupEventListeners() {
            const textarea = document.getElementById('user_input');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }

            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'h':
                            e.preventDefault();
                            showHistory();
                            break;
                        case 'a':
                            e.preventDefault();
                            showAnalytics();
                            break;
                        case 'c':
                            e.preventDefault();
                            showComparison();
                            break;
                    }
                }
                if (e.key === 'Escape') {
                    const openModals = document.querySelectorAll('.modal[style*="block"]');
                    openModals.forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        }

        function setupAnimations() {
            const cards = document.querySelectorAll('.content-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });

            const spectrumFills = document.querySelectorAll('.spectrum-fill, .confidence-fill');
            spectrumFills.forEach(fill => {
                const width = fill.style.width;
                fill.style.width = '0%';
                setTimeout(() => {
                    fill.style.width = width;
                }, 200);
            });
        }

        // Load chat history on page load
        if (document.getElementById('chat-messages')) {
            loadChatHistory();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Clear input and disable send button
            input.value = '';
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            sendButton.textContent = 'Thinking...';
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            
            // Send to backend
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    emotion: currentEmotion
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addMessageToChat('Sorry, I encountered an error. Please try again.', 'therapist');
                } else {
                    addMessageToChat(data.response, 'therapist', data.persona, data.llama_generated, data.response_time);
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                addMessageToChat('Sorry, I encountered an error. Please try again.', 'therapist');
            })
            .finally(() => {
                // Re-enable send button
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                input.focus();
            });
        }

        function addMessageToChat(message, sender, persona = null, llamaGenerated = false, responseTime = null) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div style="display: flex; justify-content: flex-end; margin: var(--spacing-md) 0;">
                        <div style="background: var(--primary-gradient); color: white; padding: var(--spacing-md) var(--spacing-lg); border-radius: 18px 18px 4px 18px; max-width: 70%; word-wrap: break-word; box-shadow: var(--shadow-soft);">
                            ${message}
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 5px; text-align: right;">
                                ${timestamp}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const statusInfo = llamaGenerated ? 
                    `<span style="color: #4caf50;">🦙 Llama</span> (${responseTime}s)` : 
                    `<span style="color: #ff9800;">⚡ Quick</span>`;
                    
                messageDiv.innerHTML = `
                    <div style="display: flex; justify-content: flex-start; margin: var(--spacing-md) 0;">
                        <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2); padding: var(--spacing-md) var(--spacing-lg); border-radius: 18px 18px 18px 4px; max-width: 70%; word-wrap: break-word; box-shadow: var(--shadow-soft);">
                            ${persona ? `<div style="font-size: 0.8rem; color: #667eea; margin-bottom: 5px; font-weight: 600;">${persona.avatar} ${persona.name}</div>` : ''}
                            ${message}
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <span>${timestamp}</span>
                                <span>${statusInfo}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            messageDiv.classList.add('chat-message');
            chatMessages.appendChild(messageDiv);
            
            // Remove welcome message if it exists
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadChatHistory() {
            fetch('/chat/history')
                .then(response => response.json())
                .then(data => {
                    if (data.history && data.history.length > 0) {
                        const chatMessages = document.getElementById('chat-messages');
                        chatMessages.innerHTML = ''; // Clear welcome message
                        
                        data.history.forEach(msg => {
                            addMessageToChat(msg.message, 'user');
                            addMessageToChat(
                                msg.response, 
                                'therapist', 
                                {avatar: '🎭', name: msg.persona}, 
                                msg.llama_generated,
                                msg.response_time
                            );
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading chat history:', error);
                });
        }

        function clearChatHistory() {
            if (confirm('Clear your chat history with the therapist?')) {
                fetch('/chat/clear')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('chat-messages').innerHTML = `
                            <div class="welcome-message" style="text-align: center; color: var(--text-muted); font-style: italic; padding: var(--spacing-xl); background: rgba(255,255,255,0.1); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                                Chat history cleared. How can I help you today?
                            </div>
                        `;
                        showNotification('Chat history cleared', 'success');
                    })
                    .catch(error => {
                        console.error('Error clearing chat:', error);
                        showNotification('Error clearing chat history', 'error');
                    });
            }
        }

        function updateChatEmotion(newEmotion) {
            currentEmotion = newEmotion;
        }

        // Form submission handling
        function handleSubmit(event) {
            showLoading();
            // Let the form submit normally
        }

        function showLoading() {
            document.querySelector('.input-form').style.display = 'none';
            document.getElementById('loading').classList.add('show');
            document.getElementById('submit-btn').disabled = true;
        }

        function hideLoading() {
            document.querySelector('.input-form').style.display = 'flex';
            document.getElementById('loading').classList.remove('show');
            document.getElementById('submit-btn').disabled = false;
        }

        // Real-time emotion preview
        function handleTextInput(textarea) {
            if (realtimePreview) {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    previewEmotion(textarea.value);
                }, typingInterval);
            }
        }

        function toggleRealtimePreview() {
            realtimePreview = !realtimePreview;
            const preview = document.getElementById('emotion-preview');
            if (realtimePreview) {
                preview.style.display = 'block';
                preview.innerHTML = '<span id="preview-text">Real-time preview enabled - start typing...</span>';
            } else {
                preview.style.display = 'none';
            }
        }

        function previewEmotion(text) {
            if (!text || text.length < 5) return;
            
            fetch('/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    texts: [text]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.comparisons && data.comparisons.length > 0) {
                    const result = data.comparisons[0];
                    document.getElementById('preview-text').innerHTML = 
                        `Preview: <strong>${result.emotion}</strong> (${result.confidence}%) - ${result.persona_name}`;
                }
            })
            .catch(error => {
                console.error('Preview error:', error);
            });
        }

        // Activity interactions
        function selectActivity(element) {
            // Remove previous selections
            document.querySelectorAll('.activities-list li').forEach(li => {
                li.style.background = 'rgba(255,255,255,0.7)';
                li.style.borderLeftColor = 'transparent';
            });
            
            // Highlight selected activity
            element.style.background = 'rgba(255,255,255,0.9)';
            element.style.borderLeftColor = '#667eea';
            
            console.log('Selected activity:', element.textContent);
        }

        function getMoreActivities(emotion) {
            fetch(`/followup/${emotion}`)
                .then(response => response.json())
                .then(data => {
                    showFollowupSuggestions(data);
                })
                .catch(error => {
                    console.error('Error fetching follow-up suggestions:', error);
                    showNotification('Error getting suggestions. Please try again.', 'error');
                });
        }

        function showFollowupSuggestions(data) {
            const followupDiv = document.getElementById('followup-suggestions');
            const contentDiv = document.getElementById('followup-content');
            
            contentDiv.innerHTML = `
                <div style="margin-bottom: var(--spacing-xl);">
                    <h4 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">🎯 Try These Activities:</h4>
                    <div style="display: grid; gap: var(--spacing-md);">
                        ${data.activities.map(activity => 
                            `<div style="padding: var(--spacing-md) var(--spacing-lg); background: rgba(255,255,255,0.8); border-radius: var(--border-radius); border-left: 4px solid #667eea; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(8px);" 
                                  onclick="selectActivity(this)"
                                  onmouseover="this.style.transform='translateX(8px)'; this.style.background='rgba(255,255,255,0.9)'"
                                  onmouseout="this.style.transform='translateX(0)'; this.style.background='rgba(255,255,255,0.8)'">
                                ${activity}
                            </div>`
                        ).join('')}
                    </div>
                </div>
                
                <div style="background: var(--accent-gradient); padding: var(--spacing-xl); border-radius: var(--border-radius-lg); margin: var(--spacing-xl) 0; color: white;">
                    <h4 style="color: white; margin-bottom: var(--spacing-md); font-weight: 600;">💭 Reflection Prompt:</h4>
                    <p style="font-size: 1.1rem; font-style: italic; line-height: 1.6;">${data.conversation_starter}</p>
                </div>
                
                <div style="background: rgba(102, 126, 234, 0.15); padding: var(--spacing-lg); border-radius: var(--border-radius); margin: var(--spacing-lg) 0; backdrop-filter: blur(8px);">
                    <strong style="color: var(--text-primary);">💡 ${data.intensity_tip || 'Personalized tip for your current state.'}</strong>
                </div>
                
                <div style="font-style: italic; color: var(--text-secondary); margin-top: var(--spacing-lg); text-align: center; padding: var(--spacing-lg); background: rgba(255,255,255,0.5); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                    ${data.persona_response}
                </div>
            `;
            
            followupDiv.style.display = 'block';
            followupDiv.classList.add('fade-in');
            followupDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Conversation starter interaction
        function startConversation() {
            const textarea = document.getElementById('user_input');
            const starter = event.target.textContent;
            textarea.value = `I'd like to talk about this: ${starter}\n\n`;
            textarea.focus();
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
            
            // Smooth scroll to input
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Persona details
        function showPersonaDetails(emotion) {
            const modal = document.getElementById('personaModal');
            const content = document.getElementById('persona-modal-content');
            
            modal.style.display = 'block';
            
            fetch(`/persona/${emotion}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('persona-modal-title').textContent = `${data.avatar} ${data.name} - Detailed Profile`;
                    
                    content.innerHTML = `
                        <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
                            <div style="font-size: 4rem; margin-bottom: var(--spacing-md); background: var(--accent-gradient); border-radius: 50%; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--spacing-md); box-shadow: var(--shadow-medium);">${data.avatar}</div>
                            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-sm); font-family: 'Playfair Display', serif;">${data.name}</h3>
                            <p style="color: var(--text-secondary); font-style: italic; font-size: 1.1rem;">${data.personality}</p>
                            <p style="margin-top: var(--spacing-md); color: var(--text-secondary); background: rgba(255,255,255,0.5); padding: var(--spacing-md); border-radius: var(--border-radius); backdrop-filter: blur(8px);">${data.specializes_in}</p>
                        </div>
                        
                        <div style="margin-bottom: var(--spacing-xl);">
                            <h4 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">🎭 Personality Traits</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-md);">
                                ${data.personality_traits.map(trait => 
                                    `<span style="background: var(--primary-gradient); color: white; padding: var(--spacing-sm) var(--spacing-md); border-radius: 20px; font-size: 0.9rem; font-weight: 500; box-shadow: var(--shadow-soft);">${trait}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: var(--spacing-xl);">
                            <h4 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">💎 Core Values</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                                ${data.core_values.map(value => 
                                    `<span style="background: rgba(102, 126, 234, 0.1); color: #1976d2; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--border-radius); font-size: 0.9rem; font-weight: 500; backdrop-filter: blur(8px);">${value}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: var(--spacing-xl);">
                            <h4 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">📊 Intensity Levels</h4>
                            ${Object.entries(data.intensity_levels).map(([level, description]) => 
                                `<div style="margin: var(--spacing-md) 0; padding: var(--spacing-md); background: rgba(255,255,255,0.6); border-radius: var(--border-radius); backdrop-filter: blur(8px); border-left: 4px solid #667eea;">
                                    <strong style="text-transform: capitalize; color: var(--text-primary);">${level}:</strong> 
                                    <span style="color: var(--text-secondary);">${description}</span>
                                </div>`
                            ).join('')}
                        </div>
                        
                        <div style="margin-bottom: var(--spacing-xl);">
                            <h4 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">💬 Communication Style</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${data.conversation_style.map(style => 
                                    `<li style="margin: var(--spacing-sm) 0; padding: var(--spacing-sm) var(--spacing-md); background: rgba(102, 126, 234, 0.1); border-radius: var(--border-radius); backdrop-filter: blur(8px);">• ${style}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">✨ Sample Quotes</h4>
                            <div style="display: grid; gap: var(--spacing-md);">
                                ${data.sample_quotes.slice(0, 3).map(quote => 
                                    `<div style="padding: var(--spacing-md); background: var(--accent-gradient); color: white; border-radius: var(--border-radius); font-style: italic; box-shadow: var(--shadow-soft);">
                                        "${quote}"
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching persona details:', error);
                    content.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: var(--spacing-xl);">Error loading persona details. Please try again.</p>';
                });
        }

        // History functionality
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('history-content');
            
            modal.style.display = 'block';
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Loading your mood history...</p>
                </div>
            `;
            
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    if (data.history && data.history.length === 0) {
                        content.innerHTML = `
                            <div style="text-align: center; padding: var(--spacing-2xl);">
                                <div style="font-size: 3rem; margin-bottom: var(--spacing-lg);">📝</div>
                                <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">No mood entries yet</h3>
                                <p style="color: var(--text-secondary); margin: var(--spacing-lg) 0; line-height: 1.6;">Start by sharing how you feel to build your mood journey!</p>
                                <button class="activity-btn" onclick="closeModal('historyModal')" style="margin-top: var(--spacing-lg);">Start Now</button>
                            </div>
                        `;
                        return;
                    }
                    
                    let historyHtml = '';
                    
                    // Add analytics overview
                    if (data.analytics) {
                        historyHtml += `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl);">
                                <div style="background: var(--primary-gradient); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-soft);">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: var(--spacing-xs);">${data.analytics.total_entries}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Entries</div>
                                </div>
                                <div style="background: var(--success-gradient); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-soft);">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: var(--spacing-xs);">${data.analytics.average_confidence}%</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Avg Confidence</div>
                                </div>
                                <div style="background: var(--warning-gradient); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-soft);">
                                    <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: var(--spacing-xs); text-transform: capitalize;">${data.analytics.most_common_emotion}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Most Common</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add history entries
                    historyHtml += data.history.map(entry => `
                        <div style="padding: var(--spacing-lg); margin: var(--spacing-lg) 0; background: var(--glass-bg); backdrop-filter: blur(16px); border-radius: var(--border-radius-lg); border: 1px solid var(--glass-border); border-left: 4px solid #667eea; transition: all 0.3s ease; box-shadow: var(--shadow-soft);" onmouseover="this.style.transform='translateX(8px)'; this.style.boxShadow='var(--shadow-medium)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='var(--shadow-soft)'">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                <div style="font-weight: 600; text-transform: capitalize; font-size: 1.1rem; color: var(--text-primary);">${entry.emotion}</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">${entry.timestamp}</div>
                            </div>
                            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); font-size: 0.9rem; flex-wrap: wrap;">
                                <div style="background: rgba(102, 126, 234, 0.1); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                                    <strong>Confidence:</strong> ${entry.confidence}%
                                </div>
                                <div style="background: rgba(102, 126, 234, 0.1); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                                    <strong>Intensity:</strong> ${entry.intensity || 'moderate'}
                                </div>
                                <div style="background: rgba(102, 126, 234, 0.1); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                                    <strong>Guided by:</strong> ${entry.persona || 'Unknown'}
                                </div>
                                ${entry.fallback_used ? '<div style="color: #ff6b6b; font-size: 0.8rem; background: rgba(255,107,107,0.1); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius);">⚠️ Keyword Analysis</div>' : ''}
                            </div>
                            ${entry.all_emotions && entry.all_emotions.length > 1 ? `
                                <div style="margin-top: var(--spacing-md); font-size: 0.9rem;">
                                    <strong>Emotion Mix:</strong> 
                                    <span style="color: var(--text-secondary);">
                                        ${entry.all_emotions.slice(0, 3).map(e => 
                                            `${e.label} (${Math.round(e.score * 100)}%)`
                                        ).join(', ')}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                    
                    content.innerHTML = historyHtml;
                })
                .catch(error => {
                    console.error('Error fetching history:', error);
                    content.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: var(--spacing-xl);">Error loading mood history. Please try again.</p>';
                });
        }

        // Analytics functionality
        function showAnalytics() {
            const modal = document.getElementById('analyticsModal');
            const content = document.getElementById('analytics-content');
            
            modal.style.display = 'block';
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Generating your analytics...</p>
                </div>
            `;
            
            fetch('/analytics')
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        content.innerHTML = `
                            <div style="text-align: center; padding: var(--spacing-2xl);">
                                <div style="font-size: 3rem; margin-bottom: var(--spacing-lg);">📊</div>
                                <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">No data available yet</h3>
                                <p style="color: var(--text-secondary); margin: var(--spacing-lg) 0; line-height: 1.6;">Share your emotions to start building analytics insights!</p>
                                <button class="activity-btn" onclick="closeModal('analyticsModal')" style="margin-top: var(--spacing-lg);">Get Started</button>
                            </div>
                        `;
                        return;
                    }
                    
                    content.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl);">
                            <div style="background: var(--primary-gradient); color: white; padding: var(--spacing-xl); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: var(--spacing-sm);">${data.overview.total_entries}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Entries</div>
                            </div>
                            <div style="background: var(--success-gradient); color: white; padding: var(--spacing-xl); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: var(--spacing-sm);">${data.overview.average_confidence}%</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Avg Confidence</div>
                            </div>
                            <div style="background: var(--warning-gradient); color: white; padding: var(--spacing-xl); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2rem; font-weight: bold; margin-bottom: var(--spacing-sm);">${data.fallback_usage.ai_analysis}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">AI Analyses</div>
                            </div>
                            <div style="background: var(--secondary-gradient); color: white; padding: var(--spacing-xl); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2rem; font-weight: bold; margin-bottom: var(--spacing-sm);">${data.fallback_usage.keyword_analysis}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Keyword Analyses</div>
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">📊 Emotion Distribution</h3>
                            <div style="display: grid; gap: var(--spacing-md);">
                                ${Object.entries(data.emotion_breakdown).map(([emotion, count]) => `
                                    <div style="display: flex; align-items: center; gap: var(--spacing-lg);">
                                        <div style="min-width: 90px; font-weight: 600; text-transform: capitalize; color: var(--text-primary);">${emotion}</div>
                                        <div style="flex-grow: 1; height: 24px; background: rgba(255,255,255,0.3); border-radius: 12px; overflow: hidden; backdrop-filter: blur(8px);">
                                            <div style="height: 100%; background: var(--primary-gradient); width: ${(count / Math.max(...Object.values(data.emotion_breakdown)) * 100)}%; border-radius: 12px; transition: width 1.5s ease;"></div>
                                        </div>
                                        <div style="min-width: 50px; text-align: right; font-weight: 600; color: var(--text-primary);">${count}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">🎭 Persona Interactions</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--spacing-lg);">
                                ${Object.entries(data.persona_interactions).map(([persona, count]) => `
                                    <div style="background: var(--glass-bg); backdrop-filter: blur(16px); padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; border: 1px solid var(--glass-border); box-shadow: var(--shadow-soft); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-medium)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-soft)'">
                                        <div style="font-size: 2.5rem; margin-bottom: var(--spacing-sm);">🎭</div>
                                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">${persona}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${count} interactions</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">⚡ Intensity Patterns</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-lg);">
                                ${Object.entries(data.intensity_patterns).map(([intensity, count]) => `
                                    <div style="background: ${intensity === 'high' ? 'linear-gradient(135deg, #ff6b6b, #ee5a52)' : intensity === 'moderate' ? 'var(--warning-gradient)' : 'var(--success-gradient)'}; color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-soft);">
                                        <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">${intensity === 'high' ? '🔥' : intensity === 'moderate' ? '⚡' : '🌱'}</div>
                                        <div style="font-weight: 600; text-transform: capitalize; margin-bottom: var(--spacing-xs);">${intensity}</div>
                                        <div style="opacity: 0.9; font-size: 0.9rem;">${count} times</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">📈 Confidence Trends</h3>
                            <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: var(--spacing-md);">Last 10 entries</div>
                            <div style="display: grid; gap: var(--spacing-sm);">
                                ${data.confidence_trends.map(entry => `
                                    <div style="display: flex; align-items: center; gap: var(--spacing-lg); padding: var(--spacing-md); background: var(--glass-bg); backdrop-filter: blur(8px); border-radius: var(--border-radius); border: 1px solid var(--glass-border);">
                                        <div style="min-width: 90px; font-size: 0.8rem; color: var(--text-secondary);">${entry.timestamp}</div>
                                        <div style="flex-grow: 1; height: 12px; background: rgba(255,255,255,0.3); border-radius: 6px; overflow: hidden;">
                                            <div style="height: 100%; background: var(--primary-gradient); width: ${entry.confidence}%; border-radius: 6px; transition: width 1s ease;"></div>
                                        </div>
                                        <div style="min-width: 60px; text-align: right; font-weight: 600; color: var(--text-primary);">${entry.confidence}%</div>
                                        <div style="min-width: 80px; text-align: right; color: var(--text-secondary); text-transform: capitalize; font-size: 0.9rem;">${entry.emotion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="background: var(--accent-gradient); color: white; padding: var(--spacing-xl); border-radius: var(--border-radius-lg); margin: var(--spacing-xl) 0; box-shadow: var(--shadow-medium);">
                            <h4 style="color: white; margin-bottom: var(--spacing-md); font-weight: 600;">🎯 Summary Insights</h4>
                            <div style="display: grid; gap: var(--spacing-sm); font-size: 0.95rem; line-height: 1.6;">
                                <p><strong>Date Range:</strong> ${data.overview.date_range.first_entry} to ${data.overview.date_range.latest_entry}</p>
                                <p><strong>Analysis Quality:</strong> ${Math.round((data.fallback_usage.ai_analysis / data.overview.total_entries) * 100)}% AI-powered</p>
                                <p><strong>Most Active Persona:</strong> ${Object.entries(data.persona_interactions).sort(([,a], [,b]) => b - a)[0]?.[0] || 'N/A'}</p>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching analytics:', error);
                    content.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: var(--spacing-xl);">Error loading analytics. Please try again.</p>';
                });
        }

        // Comparison functionality
        function showComparison() {
            const modal = document.getElementById('comparisonModal');
            modal.style.display = 'block';
            
            // Reset comparison inputs
            const inputs = document.querySelectorAll('.comparison-text');
            inputs.forEach(input => input.value = '');
            document.getElementById('comparison-results').innerHTML = '';
        }

        function addComparisonInput() {
            const container = document.getElementById('comparison-inputs');
            const inputDiv = document.createElement('div');
            inputDiv.style.cssText = 'display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md);';
            inputDiv.innerHTML = `
                <input type="text" style="flex-grow: 1; padding: var(--spacing-md); border: 2px solid rgba(255,255,255,0.2); border-radius: var(--border-radius); background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);" placeholder="Enter another text sample..." />
                <button onclick="removeComparisonInput(this)" style="padding: var(--spacing-md) var(--spacing-lg); background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 500;">Remove</button>
            `;
            container.appendChild(inputDiv);
        }

        function removeComparisonInput(button) {
            button.parentElement.remove();
        }

        function runComparison() {
            const inputs = document.querySelectorAll('#comparison-inputs input[type="text"]');
            const texts = Array.from(inputs).map(input => input.value.trim()).filter(text => text.length > 0);
            
            if (texts.length < 2) {
                showNotification('Please provide at least 2 text samples to compare.', 'warning');
                return;
            }
            
            const resultsDiv = document.getElementById('comparison-results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Comparing emotions...</p>
                </div>
            `;
            
            fetch('/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ texts: texts })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultsDiv.innerHTML = `<p style="color: #ff6b6b; text-align: center; padding: var(--spacing-lg);">Error: ${data.error}</p>`;
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <h3 style="color: #667eea; margin: var(--spacing-xl) 0 var(--spacing-lg); font-weight: 600;">📊 Comparison Results</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-lg);">
                        ${data.comparisons.map((result, index) => `
                            <div style="background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); padding: var(--spacing-lg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-soft);">
                                <div style="font-weight: 600; margin-bottom: var(--spacing-md); color: var(--text-primary);">Sample ${index + 1}</div>
                                <div style="background: rgba(255,255,255,0.8); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-md); font-size: 0.9rem; line-height: 1.5; backdrop-filter: blur(8px);">
                                    "${result.text}"
                                </div>
                                <div style="display: flex; align-items: center; gap: var(--spacing-md); margin: var(--spacing-md) 0;">
                                    <div style="font-size: 2rem; background: var(--accent-gradient); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">${result.persona_avatar}</div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${result.emotion.charAt(0).toUpperCase() + result.emotion.slice(1)}</div>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary);">${result.persona_name}</div>
                                    </div>
                                </div>
                                <div style="margin: var(--spacing-md) 0;">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                                        <span style="font-size: 0.9rem; font-weight: 500; color: var(--text-primary);">Confidence:</span>
                                        <div style="flex-grow: 1; height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; overflow: hidden;">
                                            <div style="height: 100%; background: var(--primary-gradient); width: ${result.confidence}%; border-radius: 5px; transition: width 1s ease;"></div>
                                        </div>
                                        <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-primary);">${result.confidence}%</span>
                                    </div>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: rgba(255,255,255,0.3); border-radius: var(--border-radius); backdrop-filter: blur(8px);">
                                    <strong>Intensity:</strong> <span style="text-transform: capitalize;">${result.intensity}</span>
                                    ${result.fallback_used ? ' • <span style="color: #ff6b6b;">Keyword Analysis</span>' : ' • <span style="color: #4caf50;">AI Analysis</span>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error running comparison:', error);
                resultsDiv.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: var(--spacing-xl);">Error running comparison. Please try again.</p>';
            });
        }

        // System status
        function showSystemStatus() {
            const modal = document.getElementById('systemStatusModal');
            const content = document.getElementById('system-status-content');
            
            modal.style.display = 'block';
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Checking system status...</p>
                </div>
            `;
            
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    content.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl);">
                            <div style="background: ${data.emotion_classifier.status === 'active' ? 'var(--success-gradient)' : 'var(--warning-gradient)'}; color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2.5rem; margin-bottom: var(--spacing-sm);">${data.emotion_classifier.status === 'active' ? '✅' : '⚠️'}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">AI Status</div>
                            </div>
                            <div style="background: var(--primary-gradient); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: var(--spacing-sm);">${data.personas.count}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Personas</div>
                            </div>
                            <div style="background: var(--secondary-gradient); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: var(--spacing-sm);">${data.database.total_entries}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Entries</div>
                            </div>
                            <div style="background: var(--accent-gradient); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow-medium);">
                                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: var(--spacing-sm);">${data.quotes.total_quotes}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Quotes</div>
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">🤖 Emotion Classifier</h3>
                            <div style="background: var(--glass-bg); backdrop-filter: blur(16px); padding: var(--spacing-xl); border-radius: var(--border-radius-lg); border: 1px solid var(--glass-border);">
                                <div style="margin-bottom: var(--spacing-md);"><strong>Status:</strong> <span style="color: ${data.emotion_classifier.status === 'active' ? '#4caf50' : '#ff9800'}; font-weight: 600;">${data.emotion_classifier.status.toUpperCase()}</span></div>
                                <div style="margin-bottom: var(--spacing-md);"><strong>Model:</strong> <span style="color: var(--text-secondary);">${data.emotion_classifier.model}</span></div>
                                <div><strong>Fallback Mode:</strong> <span style="color: ${data.emotion_classifier.fallback_mode ? '#ff9800' : '#4caf50'}; font-weight: 600;">${data.emotion_classifier.fallback_mode ? 'Enabled' : 'Disabled'}</span></div>
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">🎭 Available Personas</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--spacing-lg);">
                                ${data.personas.available.map(persona => `
                                    <div style="background: var(--glass-bg); backdrop-filter: blur(16px); padding: var(--spacing-lg); border-radius: var(--border-radius-lg); text-align: center; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--glass-border); box-shadow: var(--shadow-soft);" onclick="showPersonaDetails('${persona}')" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-medium)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-soft)'">
                                        <div style="font-size: 2.5rem; margin-bottom: var(--spacing-sm);">🎭</div>
                                        <div style="font-weight: 600; text-transform: capitalize; color: var(--text-primary);">${persona}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">💾 Database</h3>
                            <div style="background: var(--glass-bg); backdrop-filter: blur(16px); padding: var(--spacing-xl); border-radius: var(--border-radius-lg); border: 1px solid var(--glass-border);">
                                <div style="margin-bottom: var(--spacing-md);"><strong>Status:</strong> <span style="color: #4caf50; font-weight: 600;">CONNECTED</span></div>
                                <div style="margin-bottom: var(--spacing-md);"><strong>Total Users:</strong> <span style="color: var(--text-secondary);">${data.database.total_users}</span></div>
                                <div><strong>Total Entries:</strong> <span style="color: var(--text-secondary);">${data.database.total_entries}</span></div>
                            </div>
                        </div>
                        
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">📖 Quotes System</h3>
                            <div style="background: var(--glass-bg); backdrop-filter: blur(16px); padding: var(--spacing-xl); border-radius: var(--border-radius-lg); border: 1px solid var(--glass-border);">
                                <div style="margin-bottom: var(--spacing-md);"><strong>Source:</strong> <span style="color: var(--text-secondary);">${data.quotes.source}</span></div>
                                <div style="margin-bottom: var(--spacing-md);"><strong>Emotions Covered:</strong> <span style="color: var(--text-secondary);">${data.quotes.emotions_covered.join(', ')}</span></div>
                                <div><strong>Total Quotes:</strong> <span style="color: var(--text-secondary);">${data.quotes.total_quotes}</span></div>
                            </div>
                        </div>

                        ${data.llama ? `
                        <div style="margin: var(--spacing-2xl) 0;">
                            <h3 style="color: #667eea; margin-bottom: var(--spacing-lg); font-weight: 600;">🦙 Llama Integration</h3>
                            <div style="background: var(--glass-bg); backdrop-filter: blur(16px); padding: var(--spacing-xl); border-radius: var(--border-radius-lg); border: 1px solid var(--glass-border);">
                                <div style="margin-bottom: var(--spacing-md);"><strong>Available:</strong> <span style="color: ${data.llama.available ? '#4caf50' : '#ff9800'}; font-weight: 600;">${data.llama.available ? 'YES' : 'NO'}</span></div>
                                <div style="margin-bottom: var(--spacing-md);"><strong>Model:</strong> <span style="color: var(--text-secondary);">${data.llama.model}</span></div>
                                <div><strong>Chat Enabled:</strong> <span style="color: ${data.llama.chat_enabled ? '#4caf50' : '#ff9800'}; font-weight: 600;">${data.llama.chat_enabled ? 'YES' : 'NO'}</span></div>
                            </div>
                        </div>
                        ` : ''}
                    `;
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                    content.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: var(--spacing-xl);">Error loading system status. Please try again.</p>';
                });
        }

        // Demo controls
        function resetDemo() {
            if (confirm('This will clear all demo data. Continue?')) {
                fetch('/demo/reset')
                    .then(response => response.json())
                    .then(data => {
                        showNotification(data.message, 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Error resetting demo:', error);
                        showNotification('Error resetting demo', 'error');
                    });
            }
        }

        function generateSampleData() {
            fetch('/demo/sample-data')
                .then(response => response.json())
                .then(data => {
                    showNotification(`Generated ${data.entries.length} sample entries!`, 'success');
                    console.log('Sample data generated:', data.entries);
                })
                .catch(error => {
                    console.error('Error generating sample data:', error);
                    showNotification('Error generating sample data', 'error');
                });
        }

        // Additional functionality
        function showDetailedAnalysis() {
            {% if emotion_data %}
            const analysisText = `
                Your detailed emotion analysis shows:
                
                Primary Emotion: {{ emotion_data.emotion.title() }} ({{ "%.1f"|format(emotion_data.confidence * 100) }}% confidence)
                Intensity Level: {{ emotion_data.intensity or 'moderate' }}
                Analysis Method: {% if emotion_data.fallback_used %}Keyword-based detection{% else %}AI-powered recognition{% endif %}
                
                Full Emotion Spectrum:
                {% for emotion in emotion_data.all_emotions[:3] %}
                - {{ emotion.label.title() }}: {{ "%.1f"|format(emotion.score * 100) }}%{% endfor %}
                
                This analysis helped match you with {{ persona.name }}, who specializes in {{ persona.personality }} support.
            `;
            
            showNotification(analysisText, 'info', 8000);
            {% else %}
            showNotification('No analysis data available. Please share your emotions first!', 'warning');
            {% endif %}
        }

        function explainAnalysis() {
            const explanationText = `
                🤖 How MoodMate's Emotion Analysis Works:
                
                1. **AI Processing**: We use advanced natural language processing to analyze your text
                2. **Emotion Detection**: The system identifies 7 core emotions with confidence scores
                3. **Intensity Analysis**: We detect how strongly you're feeling each emotion
                4. **Persona Matching**: Based on your primary emotion, we select the most suitable AI companion
                5. **Personalized Response**: Each persona provides unique support tailored to their personality
                
                Our system includes a robust fallback mechanism that uses keyword analysis when the AI model isn't available, ensuring you always receive support.
            `;
            
            showNotification(explanationText, 'info', 10000);
        }

        // Utility functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function typeWriterEffect(selector, speed = 50) {
            const element = document.querySelector(selector);
            if (!element) return;
            
            const text = element.textContent;
            element.textContent = '';
            element.style.opacity = '1';
            let i = 0;
            
            function typeWriter() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                

        // Add CSS animations for enhanced effects
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(100px) scale(0.8); }
                to { opacity: 1; transform: translateX(0) scale(1); }
            }
            
            @keyframes slideOutRight {
                from { opacity: 1; transform: translateX(0) scale(1); }
                to { opacity: 0; transform: translateX(100px) scale(0.8); }
            }

            .close:hover {
                color: var(--text-primary) !important;
                transform: scale(1.1);
            }

            /* Enhanced loading states */
            .loading p {
                font-size: 1.1rem;
                margin-top: var(--spacing-md);
            }

            /* Chat message styles */
            .chat-message {
                margin: var(--spacing-md) 0;
                animation: messageSlideIn 0.3s ease;
            }

            @keyframes messageSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Hover effects for interactive elements */
            .persona-avatar:hover {
                box-shadow: 0 0 30px rgba(255,255,255,0.4);
            }

            .floating-btn:hover {
                box-shadow: var(--shadow-strong);
            }

            /* Enhanced focus states */
            *:focus {
                outline: 2px solid rgba(255,255,255,0.6);
                outline-offset: 2px;
            }

            /* Smooth transitions for all interactive elements */
            button, input, textarea, .content-card, .floating-btn {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Enhanced glassmorphism effect */
            .glass-container:hover {
                border-color: rgba(255,255,255,0.3);
                box-shadow: var(--shadow-medium);
            }

            /* Improved responsiveness */
            @media (max-width: 1024px) {
                .content-grid {
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                }
            }

            @media (max-width: 640px) {
                .persona-header {
                    text-align: center;
                }
                
                .emotion-confidence {
                    flex-direction: column;
                    gap: var(--spacing-sm);
                }
                
                .chat-input-section {
                    flex-direction: column;
                }
                
                .chat-input {
                    border-radius: var(--border-radius);
                }
            }
        `;
        document.head.appendChild(style);

        // Enhanced performance optimization
        let isScrolling = false;
        let ticking = false;

        function updateScrollEffects() {
            // Add scroll-based effects here if needed
            ticking = false;
        }

        window.addEventListener('scroll', function() {
            if (!ticking) {
                requestAnimationFrame(updateScrollEffects);
                ticking = true;
            }
        });

        // Theme switching based on emotion
        function updateTheme(emotion) {
            document.body.className = `theme-transition ${emotion}`;
            
            // Update CSS custom properties for dynamic theming
            const root = document.documentElement;
            const themeColors = {
                joy: '#ffeaa7',
                sadness: '#74b9ff',
                anger: '#fd79a8',
                fear: '#a29bfe',
                love: '#fd79a8',
                surprise: '#fdcb6e',
                neutral: '#81ecec'
            };
            
            if (themeColors[emotion]) {
                root.style.setProperty('--theme-color', themeColors[emotion]);
            }
        }

        // Enhanced accessibility features
        function initAccessibility() {
            // Add keyboard navigation for cards
            const cards = document.querySelectorAll('.content-card');
            cards.forEach((card, index) => {
                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'region');
                card.setAttribute('aria-label', `Content card ${index + 1}`);
            });

            // Add ARIA labels for interactive elements
            const floatingBtns = document.querySelectorAll('.floating-btn');
            floatingBtns.forEach(btn => {
                const title = btn.getAttribute('title');
                if (title) {
                    btn.setAttribute('aria-label', title);
                }
            });
        }

        // Initialize all enhancements
        document.addEventListener('DOMContentLoaded', function() {
            initAccessibility();
            
            // Add smooth reveal animations for content
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, { threshold: 0.1 });

            // Observe all content cards for scroll animations
            document.querySelectorAll('.content-card').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(card);
            });
        });

        // Error handling for better UX
        window.addEventListener('error', function(e) {
            console.error('Application error:', e);
            showNotification('Something went wrong. Please refresh the page.', 'error');
        });

        // Service worker registration for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Uncomment to enable service worker
                // navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>